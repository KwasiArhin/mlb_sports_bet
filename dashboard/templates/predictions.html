{% extends "base.html" %}

{% block title %}Today's Predictions - MLB Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-line me-2 text-primary"></i>
        Today's Betting Recommendations
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportPredictions()">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>
</div>

{% if predictions %}
    <!-- Live Games Alert -->
    {% if predictions[0].get('Live_Game') %}
    <div class="alert alert-info" role="alert">
        <i class="fas fa-satellite-dish me-2"></i>
        <strong>Live Games Detected!</strong> 
        Showing today's games fetched from MLB APIs. 
        <button class="btn btn-sm btn-primary ms-2" onclick="generatePredictions()">
            <i class="fas fa-brain"></i> Generate Predictions & Kelly Sizing
        </button>
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">{{ predictions|length }}</h5>
                    <p class="card-text">Total Games</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set recommended_bets = predictions|selectattr("kelly_edge")|list|length if predictions else 0 %}
                    <h5 class="card-title text-success">{{ recommended_bets }}</h5>
                    <p class="card-text">Recommended Bets</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set total_bet = 0 %}
                    {% for pred in predictions %}
                        {% if pred.kelly_edge and pred.bet_size %}
                            {% set bet_amount = pred.bet_size|replace("$", "")|replace(",", "")|float %}
                            {% set total_bet = total_bet + bet_amount %}
                        {% endif %}
                    {% endfor %}
                    <h5 class="card-title text-warning">${{ "%.2f"|format(total_bet) }}</h5>
                    <p class="card-text">Total Bet Amount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    {% set hit_rate = (recommended_bets / predictions|length * 100) if predictions|length > 0 else 0 %}
                    <h5 class="card-title text-info">{{ "%.1f"|format(hit_rate) }}%</h5>
                    <p class="card-text">Hit Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Betting Recommendations -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-list-ol me-2"></i>
            Game-by-Game Analysis
        </div>
        <div class="card-body">
            <div class="row">
                {% for prediction in predictions %}
                <div class="col-md-6 mb-3">
                    <div class="card {{ 'bet-recommendation' if prediction.kelly_edge else 'no-bet' }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="matchup-container">
                                    <div class="team-info">
                                        <img src="{{ prediction.away_team_logo }}" alt="{{ prediction.away_team }}" class="team-logo">
                                        <div class="team-details">
                                            <span class="team-name">{{ prediction.away_team }}</span>
                                            <div class="team-win-prob">{{ prediction.away_win_prob }}</div>
                                        </div>
                                    </div>
                                    <span class="text-muted vs-separator">@</span>
                                    <div class="team-info">
                                        <img src="{{ prediction.home_team_logo }}" alt="{{ prediction.home_team }}" class="team-logo">
                                        <div class="team-details">
                                            <span class="team-name">{{ prediction.home_team }}</span>
                                            <div class="team-win-prob">{{ prediction.home_win_prob }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% if prediction.kelly_edge %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-thumbs-up"></i> BET
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-ban"></i> SKIP
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Win Probability</small>
                                    <p class="mb-1">
                                        <strong>{{ prediction.win_probability }}</strong>
                                    </p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Recommended Bet</small>
                                    <p class="mb-1">
                                        <strong class="{{ 'text-success' if prediction.kelly_edge else 'text-muted' }}">
                                            {{ prediction.bet_size }}
                                        </strong>
                                    </p>
                                </div>
                            </div>
                            
                            {% if prediction.kelly_edge %}
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <small class="text-muted">Team to Bet</small>
                                        <p class="mb-0 d-flex align-items-center">
                                            <img src="{{ prediction.team_to_bet_logo }}" alt="{{ prediction.team_to_bet }}" class="team-logo-small me-2">
                                            <strong class="text-primary">{{ prediction.team_to_bet }}</strong>
                                        </p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Expected Value</small>
                                        <p class="mb-0">
                                            <strong class="{{ 'text-success' if prediction.expected_value.startswith('+') else 'text-danger' }}">
                                                {{ prediction.expected_value }}
                                            </strong>
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Odds: {{ prediction.odds_used }} | 
                                        Edge: {{ "%.1f"|format((prediction.win_probability|replace("%", "")|float / 100 - 0.524) * 100) }}%
                                    </small>
                                </div>
                            {% else %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Insufficient edge detected - Kelly Criterion suggests no bet
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Risk Management Summary -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shield-alt me-2"></i>
                    Risk Management
                </div>
                <div class="card-body">
                    {% set total_bet = predictions|selectattr("kelly_edge")|map(attribute="bet_size")|map("replace", "$", "")|map("replace", ",", "")|map("float")|sum %}
                    {% set recommended_bets_list = predictions|selectattr("kelly_edge")|map(attribute="bet_size")|map("replace", "$", "")|map("replace", ",", "")|map("float")|list %}
                    {% set max_bet = recommended_bets_list|max if recommended_bets_list else 0 %}
                    
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Total Risk:</strong><br>
                            ${{ "%.2f"|format(total_bet) }}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Largest Single Bet:</strong><br>
                            ${{ "%.2f"|format(max_bet) }}</p>
                        </div>
                    </div>
                    
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: {{ (total_bet / 1000) * 100 }}%" 
                             aria-valuenow="{{ (total_bet / 1000) * 100 }}" aria-valuemin="0" aria-valuemax="100">
                            {{ "%.1f"|format((total_bet / 1000) * 100) }}% of $1,000 bankroll
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        Kelly Criterion ensures optimal bet sizing to maximize long-term growth while managing risk.
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-lightbulb me-2"></i>
                    Betting Tips
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check-circle text-success me-2"></i>
                            Only bet when Kelly Criterion shows positive edge</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>
                            Never bet more than the recommended Kelly amount</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>
                            Consider fractional Kelly for extra safety</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>
                            Track actual results vs predictions</li>
                    </ul>
                    
                    <div class="alert alert-warning alert-sm">
                        <strong>Remember:</strong> Past performance doesn't guarantee future results. 
                        Bet responsibly and within your means.
                    </div>
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- No predictions available -->
    <div class="text-center py-5">
        <div class="card">
            <div class="card-body">
                <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                <h3>No Predictions Available</h3>
                <p class="text-muted">
                    No predictions have been generated for today yet. 
                    The model may still be processing or data might not be available.
                </p>
                
                <div class="mt-4">
                    <button class="btn btn-primary me-2" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh Page
                    </button>
                    <a href="/pipeline-status" class="btn btn-outline-secondary">
                        <i class="fas fa-cogs"></i> Check Pipeline Status
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    function generatePredictions() {
        if (confirm('Generate predictions and Kelly sizing for today\\'s games? This may take 2-5 minutes.')) {
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            button.disabled = true;
            
            // Generate predictions via API
            fetch('http://localhost:5001/api/predictions/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'date': new Date().toISOString().split('T')[0],
                    'bankroll': 1000,
                    'odds': 1.91
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Predictions generated successfully! Found ${data.summary.recommended_bets} betting opportunities. Refreshing page now...`);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Failed to generate predictions: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error starting pipeline: ' + error.message);
            })
            .finally(() => {
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }
    
    function exportPredictions() {
        // Simple CSV export functionality
        const predictions = {{ predictions|tojson }};
        
        if (!predictions || predictions.length === 0) {
            alert('No predictions to export');
            return;
        }
        
        const csvContent = [
            'Game,Matchup,Win_Probability,Team_To_Bet,Bet_Size,Expected_Value,Kelly_Edge,Odds',
            ...predictions.map(p => [
                p.game_date,
                p.matchup,
                p.win_probability,
                p.team_to_bet,
                p.bet_size,
                p.expected_value,
                p.kelly_edge,
                p.odds_used
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mlb_predictions_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
    
    // Auto-refresh every 10 minutes
    setTimeout(function() {
        location.reload();
    }, 600000);
</script>
{% endblock %}